(function(){"use strict";const A={reportId:/REPORT ID:\s*(SMS6\d+[A-Z]?)/i,pageNumber:/PAGE NUMBER\s*:\s*(\d+)/i,fundsTransfer:/FUNDS XFR:\s*(\d+)\s+(.+?)\s{2,}/i,processor:/PROCESSOR:\s*(\d+)\s+(.+?)\s{2,}/i,affiliate:/AFFILIATE:\s*(\d+)\s+(.+?)\s{2,}/i,sre:/SRE\s*:\s*(\d+)\s+(.+?)\s{2,}/i,onlineSettlementDate:/ONLINE SETTLMNT DATE:\s*(\d{2}\w{3}\d{2})/i,runDate:/(RUN DATE|REPORT DATE)\s*:\s*(\d{2}\w{3}\d{2})/i,runTime:/(RUN TIME|REPORT TIME)\s*:\s*(\d{2}:\d{2}:\d{2})/i,vssProcessingDate:/VSS PROCESSING DATE\s*:\s*(\d{2}\w{3}\d{2})/i,settlementCurrency:/AMOUNT\s*\(([A-Z]{3})\)/i,nationalNet:/NATIONAL NET/i,transactionLine1:/^\s*(\d+)\s+(\d{2}\w{3})\s+(\d{2}:\d{2}:\d{2})\s+([\dxX]+)\s+(\S+)\s+(\d+)\s+(\d+)\s+(\d{4})\s+(\d{6})\s+(\d+(?:\.\d{2})?)\s+(\d+(?:\.\d{2})?)\s+(\d+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)\s+([A-Z]{3})\s+([\d,]+(?:\.\d{2})?)\s*(?:(CR|DR))?\s*$/i,transactionLine1Extended:/^\s*(\d+)\s+(\d{2}\w{3})\s+(\d{2}:\d{2}:\d{2})\s+([\dxX]+)\s+(\S+)\s+(\d+)\s+(\d+)\s+(\d{4})\s+(\d{6})\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([A-Z]{3})\s+([\d,]+(?:\.\d{2})?)\s*(?:(CR|DR))?\s*$/i,transactionLine2:/^\s*(\d{4}|\d{2}\w{3})?\s*(\d{2}:\d{2}:\d{2})?\s*CA ID:\s*(\S+)?\s+(\S+)?\s+(\d+)?\s+(\d{2})?\/(.+?)\/(\w{2})\s+(\d{4})/i,transactionLine3CDSQ:/CD SQ:\s*(\d+)\s+ATC:\s*(\w+)(?:\s+CI:\s*(\d+))?(?:\s+M\/EC:\s*(\w+))?(?:\s+AP:\s*(\w+))?/i,transactionLine3ATC:/ATC:\s*(\w+)(?:\s+CI:\s*(\d+))?(?:\s+M\/EC:\s*(\w+))?/i,transactionLine4Usage:/USAGE:\s*(\w+)\s+TR ID:\s*([\w\/]+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?(?:\s+PTS:\s*([\w\s]+))?(?:\s+PMC:\s*(\w+))?(?:\s+SCHG:\s*([\d,\.]+))?/i,transactionLine4DgCd:/DG CD:\s*(\w+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?/i,transactionLine4TrId:/TR ID:\s*([\w\/]+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?/i,transactionLine5:/FEE JURIS:\s*(.+?)\s+ROUTING:\s*(.+?)\s+FEE LEVEL:\s*(.+?)\s+([\d,\.]+)(CR|DR)?/i,transactionLine5RoutingOnly:/ROUTING:\s*(.+?)(?:\s+FEE LEVEL:|\s*$)/i,feeJuris:/FEE JURIS:/i,fpi:/FPI:\s*(\w+)/i,affiliateSummary:/AFFILIATE ID:\s*(\d+)\s+(.+?)(?:,|\s{2,})/i,debitsLine:/DEBITS\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})DR/i,creditsLine:/CREDITS\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})CR/i,totalLine:/TOTAL\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})(CR|DR)/i,subtotalLine:/SUBTOTAL\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})(CR|DR)/i,nonFinancialLine:/NON FINANCIAL\s*:\s*(\d+)/i,totalFeesLine:/TOTAL FEES\s*:\s*(\d+)/i,debitsLineExtended:/DEBITS\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,creditsLineExtended:/CREDITS\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,subtotalLineExtended:/SUBTOTAL\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,totalFeesLineExtended:/TOTAL FEES\s*:\s*(\d+)\s+([\d,.]+)(CR|DR)/i},I={"00":"Purchase/Sale","01":"Cash Advance","09":"Purchase with Cashback",10:"Financial Cash Withdrawal",11:"Cash Transaction Reversal",20:"Balance Inquiry",22:"Purchase Refund",26:"Cash Advance Refund",30:"Funds Transfer",31:"Utility Payment",40:"Cardholder Account Transfer",50:"ATM Withdrawal",51:"PIN Unblock",90:"Administrative Message"},S={"00":"Not Specified / Not Applicable",10:"Savings Account",20:"Checking Account (Current Account)",30:"Credit Card Account",40:"Universal Account",50:"Investment Account",60:"Bonus Account"};function h(i){if(!/^\d{6}$/.test(i))return;const a=i.substring(0,2),t=i.substring(2,4),o=i.substring(4,6);return{transactionType:a,transactionTypeDescription:I[a]||`Unknown (${a})`,fromAccountType:t,fromAccountTypeDescription:S[t]||`Unknown (${t})`,toAccountType:o,toAccountTypeDescription:S[o]||`Unknown (${o})`}}function g(i){const a=i.split(`
`);let t={};for(let o=0;o<Math.min(20,a.length);o++){const s=a[o],r=s.match(A.reportId),e=s.match(A.pageNumber),n=s.match(A.fundsTransfer),u=s.match(A.processor),m=s.match(A.affiliate),l=s.match(A.sre),c=s.match(A.onlineSettlementDate),T=s.match(A.runDate),d=s.match(A.runTime),R=s.match(A.vssProcessingDate),p=s.match(A.settlementCurrency);r&&(t.reportId=r[1]),e&&(t.pageNumber=parseInt(e[1])),n&&(t.fundsTransferSRE=n[1],t.fundsTransferName=n[2].trim()),u&&(t.processor=u[1],t.processorName=u[2].trim()),m&&(t.affiliate=m[1],t.affiliateName=m[2].trim()),l&&(t.sre=l[1],t.sreName=l[2].trim()),c&&(t.onlineSettlementDate=c[1]),T&&(t.runDate=T[2]),d&&(t.runTime=d[2]),R&&(t.vssProcessingDate=R[1]),p&&(t.settlementCurrency=p[1]),A.nationalNet.test(s)&&(t.nationalNet=!0)}if(t.settlementCurrency||(t.settlementCurrency="USD"),t.sreName){const o=t.sreName.match(/^(\d{6,8})/);if(o){let s=o[1];t.bin=s}}if(!t.bin&&t.affiliate){const o=t.affiliate.substring(0,8);if(/^\d{8}$/.test(o)){let s=o;s.length===8&&s.endsWith("00")&&(s=s.substring(0,6)),t.bin=s}}return t.reportId?t:null}function N(i,a){const t=i.split(`
`),o=[];let s=0;for(;s<t.length;){const r=t[s].trim();let e=r.match(A.transactionLine1Extended),n=!!e;if(e||(e=r.match(A.transactionLine1)),e){let u=e[4];const m=/[xX]/.test(u);let l=u;l.length===16?l=u:l.length===19&&l.endsWith("000")?l=u.substring(0,16):l.length>16&&l.endsWith("000")&&(l=l.substring(0,l.length-3));let c;if(n){const T=e[9],d=h(T);c={batchNumber:e[1],transmitDate:e[2],transmitTime:e[3],cardNumber:l,masked:m||void 0,retrievalRefNumber:e[5],traceNumber:e[6],acquirerId:e[7],transactionType:e[8],processingCode:T,processingCodeParsed:d,transactionSubtype:d?.transactionTypeDescription,entryMode:e[10],reasonCode:e[11],conditionCode:e[12],responseCode:e[13],cardholderBillingAmount:e[14],cardholderBillingCurrency:e[15],settlementAmount:e[16],settlementCurrency:a.settlementCurrency,settlementType:e[17]||"DR"}}else{const T=e[9],d=h(T);c={batchNumber:e[1],transmitDate:e[2],transmitTime:e[3],cardNumber:l,masked:m||void 0,retrievalRefNumber:e[5],traceNumber:e[6],acquirerId:e[7],transactionType:e[8],processingCode:T,processingCodeParsed:d,transactionSubtype:d?.transactionTypeDescription,entryMode:e[10],reasonCode:e[11],responseCode:e[12],cardholderBillingAmount:e[13],cardholderBillingCurrency:e[14],settlementAmount:e[15],settlementCurrency:a.settlementCurrency,settlementType:e[16]||"DR"}}if(s++,s<t.length&&t[s].includes("CA ID:")){const T=t[s],d=T.match(A.transactionLine2);d&&(d[3]&&(c.cardAcceptorTerminalId=d[3]),d[4]&&(c.cardAcceptorId=d[4]),d[7]&&(c.merchantName=d[7].trim()),d[8]&&(c.merchantCountryCode=d[8]));const R=T.match(A.fpi);R&&(c.feeProgramIndicator=R[1]),s++}if(s<t.length){const T=t[s];(T.match(A.transactionLine3CDSQ)||T.match(A.transactionLine3ATC)||T.includes("M/EC:"))&&s++}if(s<t.length){const T=t[s],d=T.match(A.transactionLine4Usage);if(d)c.usage=d[1],c.transactionIdentifier=d[2],d[3]&&(c.authCharIndicator=d[3]),d[4]&&(c.validationCode=d[4]),s++;else{const R=T.match(A.transactionLine4DgCd);if(R)c.downgradeCode=R[1],R[2]&&(c.authCharIndicator=R[2]),R[3]&&(c.validationCode=R[3]),s++;else{const p=T.match(A.transactionLine4TrId);p&&(c.transactionIdentifier=p[1],p[2]&&(c.authCharIndicator=p[2]),p[3]&&(c.validationCode=p[3]),s++)}}}if(s<t.length){const T=t[s];if(A.feeJuris.test(T)){const d=T.match(A.transactionLine5);d&&(c.feeJurisdiction=d[1].trim(),c.routing=d[2].trim(),c.feeLevel=d[3].trim(),d[4]&&(c.feeAmount=d[4],d[5]&&(c.feeType=d[5]))),s++}else if(T.includes("ROUTING:")){const d=T.match(A.transactionLine5RoutingOnly);d&&(c.routing=d[1].trim()),s++}}o.push(c)}else s++}return o}function b(i){const a=i.split(`
`);let t={};for(const o of a){const s=o.match(A.affiliateSummary),r=o.match(A.debitsLine),e=o.match(A.creditsLine),n=o.match(A.totalLine),u=o.match(A.subtotalLine),m=o.match(A.nonFinancialLine),l=o.match(A.totalFeesLine),c=o.match(A.debitsLineExtended),T=o.match(A.creditsLineExtended),d=o.match(A.subtotalLineExtended),R=o.match(A.totalFeesLineExtended);if(s&&(t.affiliateId=s[1],t.affiliateName=s[2].trim()),c?(t.debitsCount=parseInt(c[1]),t.debitsAmount=c[3],t.debits={count:parseInt(c[1]),billingAmount:c[2],settlementAmount:c[3],settlementType:c[4]}):r&&(t.debitsCount=parseInt(r[1]),t.debitsAmount=r[3]),T?(t.creditsCount=parseInt(T[1]),t.creditsAmount=T[3],t.credits={count:parseInt(T[1]),billingAmount:T[2],settlementAmount:T[3],settlementType:T[4]}):e&&(t.creditsCount=parseInt(e[1]),t.creditsAmount=e[3]),d)t.totalCount=parseInt(d[1]),t.totalAmount=d[3],t.totalType=d[4],t.subtotal={count:parseInt(d[1]),billingAmount:d[2],settlementAmount:d[3],settlementType:d[4]};else if(n||u){const p=n||u;p&&(t.totalCount=parseInt(p[1]),t.totalAmount=p[3],t.totalType=p[4])}m&&(t.nonFinancialCount=parseInt(m[1])),R?(t.totalFeesCount=parseInt(R[1]),t.totalFeesAmount=R[2],t.totalFees={count:parseInt(R[1]),amount:R[2],type:R[3]}):l&&(t.totalFeesCount=parseInt(l[1]))}return t.affiliateId?t:null}function M(i,a){const t=[],o={status:"parsing",currentLine:0,totalLines:i.split(`
`).length,reportsFound:0,transactionsParsed:0};try{const s=i.split(/REPORT ID:/i);for(let e=1;e<s.length;e++){const n=s[e],u="REPORT ID:"+n;if(/^\s*SMS6/i.test(n)){const m=g(u);if(m){const l=N(u,m),c=b(u),T={header:m,transactions:l,summary:c||void 0,rawContent:u};t.push(T),o.reportsFound++,o.transactionsParsed+=l.length,a?.(o)}}}o.status="completed",a?.(o);const r={totalReports:t.length,totalTransactions:o.transactionsParsed,totalDebits:t.reduce((e,n)=>e+n.transactions.filter(u=>u.settlementType==="DR").length,0),totalCredits:t.reduce((e,n)=>e+n.transactions.filter(u=>u.settlementType==="CR").length,0)};return{reports:t,progress:o,summary:r}}catch(s){throw o.status="error",o.errorMessage=s instanceof Error?s.message:"Unknown error",a?.(o),s}}function f(i){const a=i.replace(/,/g,"").trim();return parseFloat(a)||0}function L(i){const a=/^\s*TOTAL\s+(?:ACQUIRER|ISSUER|OTHER|INTERCHANGE\s+VALUE|REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=/^\s*TOTAL\s+(?:ACQUIRER|ISSUER|OTHER|INTERCHANGE\s+VALUE|REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,o=/^\s*NET\s+SETTLEMENT\s+AMOUNT\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i;let s=i.match(a);if(s){const r=parseInt(s[1].replace(/,/g,"")),e=f(s[2]),n=f(s[3]),u=f(s[4]);return{count:r,creditAmount:e,debitAmount:n,totalAmount:s[5]==="DB"?-u:u}}if(s=i.match(t),s){const r=f(s[1]),e=f(s[2]),n=f(s[3]);return{creditAmount:r,debitAmount:e,totalAmount:s[4]==="DB"?-n:n}}if(s=i.match(o),s){const r=f(s[1]),e=f(s[2]),n=f(s[3]);return{creditAmount:r,debitAmount:e,totalAmount:s[4]==="DB"?-n:n}}return null}function O(i){const a=i.split(`
`),t={reportId:"",pageNumber:1,reportingFor:"",reportingForName:"",rollupTo:"",rollupToName:"",fundsTransferEntity:"",fundsTransferEntityName:"",settlementService:"",reportTitle:"",settlementCurrency:"",processingDate:"",reportDate:""};return a.forEach((o,s)=>{const r=o.match(/REPORT\s+ID:\s+(VSS-\d+)\s+(.+?)\s+PAGE:\s+(\d+)/i);if(r){t.reportId=r[1],t.settlementService=r[2].trim(),t.pageNumber=parseInt(r[3]),t.lineNumber=s+1;return}let e=o.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s{2,}([A-Z\s]+SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i);if(e||(e=o.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*?)\s+([A-Z]+\s+(?:[A-Z]+\s+)*SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i)),e){t.reportingFor=e[1],t.reportingForName=e[2].trim().replace(/\s+/g," "),t.settlementService=e[3].trim(),t.processingDate=e[4].trim();return}let n=o.match(/ROLLUP\s+TO:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s+(SETTLEMENT\s+SUMMARY\s+REPORT|SRE\s+SETTLEMENT\s+RECAP\s+REPORT)\s+REPORT\s+DATE:\s+(\S+)\s*$/i);if(n){t.rollupTo=n[1],t.rollupToName=n[2].trim().replace(/\s+/g," "),t.reportTitle=n[3].trim(),t.reportDate=n[4].trim();return}const u=o.match(/FUNDS\s+(?:XFER|TRANSFER)\s+ENTITY:\s+(\d+)\s+(.+?)\s*$/i);if(u){t.fundsTransferEntity=u[1],t.fundsTransferEntityName=u[2].trim();return}const m=o.match(/SETTLEMENT\s+CURRENCY:\s+([A-Z]{3})/i);if(m){t.settlementCurrency=m[1];return}const l=o.match(/CLEARING\s+CURRENCY:\s+([A-Z]{3})/i);if(l){t.clearingCurrency=l[1];return}const c=o.match(/FOR\s+(.+?)\s+THROUGH\s+(.+?)(?:\s+LAST\s+CHANGE:\s+(.+?))?$/i);if(c){t.forDate=c[1].trim(),t.throughDate=c[2].trim(),c[3]&&(t.lastChange=c[3].trim());return}}),t}function D(i){const a=i.split(`
`),t={interchangeValue:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},reimbursementFees:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},visaCharges:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},total:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},netSettlementAmount:{creditAmount:0,debitAmount:0,totalAmount:0}}},o=i.match(/FUNDS\s+TRANSFER\s+AMOUNT:\s+([\d,]+\.?\d*)(CR|DB)?/i);if(o){const r=f(o[1]);t.fundsTransferAmount={amount:o[2]==="DB"?-r:r,type:o[2]||"CR"}}let s="";for(let r=0;r<a.length;r++){const e=a[r];if(/^\s*INTERCHANGE\s+VALUE\s*$/i.test(e)){s="INTERCHANGE_VALUE";continue}if(/^\s*REIMBURSEMENT\s+FEES\s*$/i.test(e)){s="REIMBURSEMENT_FEES";continue}if(/^\s*VISA\s+CHARGES\s*$/i.test(e)){s="VISA_CHARGES";continue}if(/^\s*TOTAL\s*$/i.test(e)&&!e.match(/TOTAL\s+(ACQUIRER|ISSUER|OTHER)/i)){s="TOTAL";continue}const n=L(e);n&&(s==="INTERCHANGE_VALUE"?/TOTAL\s+ACQUIRER/i.test(e)?t.interchangeValue.totalAcquirer=n:/TOTAL\s+ISSUER/i.test(e)?t.interchangeValue.totalIssuer=n:/TOTAL\s+OTHER/i.test(e)?t.interchangeValue.totalOther=n:/TOTAL\s+INTERCHANGE\s+VALUE/i.test(e)&&(t.interchangeValue.total=n):s==="REIMBURSEMENT_FEES"?/TOTAL\s+ACQUIRER/i.test(e)?t.reimbursementFees.totalAcquirer=n:/TOTAL\s+ISSUER/i.test(e)?t.reimbursementFees.totalIssuer=n:/TOTAL\s+OTHER/i.test(e)?t.reimbursementFees.totalOther=n:/TOTAL\s+REIMBURSEMENT\s+FEES/i.test(e)&&(t.reimbursementFees.total=n):s==="VISA_CHARGES"?/TOTAL\s+ACQUIRER/i.test(e)?t.visaCharges.totalAcquirer=n:/TOTAL\s+ISSUER/i.test(e)?t.visaCharges.totalIssuer=n:/TOTAL\s+OTHER/i.test(e)?t.visaCharges.totalOther=n:/TOTAL\s+VISA\s+CHARGES/i.test(e)&&(t.visaCharges.total=n):s==="TOTAL"&&(/TOTAL\s+ACQUIRER/i.test(e)?t.total.totalAcquirer=n:/TOTAL\s+ISSUER/i.test(e)?t.total.totalIssuer=n:/TOTAL\s+OTHER/i.test(e)?t.total.totalOther=n:/NET\s+SETTLEMENT\s+AMOUNT/i.test(e)&&(t.total.netSettlementAmount=n)))}return t}function y(i){const a=O(i),t=D(i);return{reportType:"VSS-110",header:a,data:t,rawContent:i}}function F(i){return/REPORT\s+ID:\s+VSS-110/i.test(i)&&/SETTLEMENT\s+SUMMARY\s+REPORT/i.test(i)}function E(i){const a=i.replace(/,/g,"").trim();return parseFloat(a)||0}function U(i){const a=i.split(`
`),t={reportId:"",pageNumber:1,reportingFor:"",reportingForName:"",rollupTo:"",rollupToName:"",fundsTransferEntity:"",fundsTransferEntityName:"",settlementService:"",reportTitle:"",settlementCurrency:"",processingDate:"",reportDate:""};return a.forEach((o,s)=>{const r=o.match(/REPORT\s+ID:\s+(VSS-\d+)\s+(.+?)\s+PAGE:\s+(\d+)/i);if(r){t.reportId=r[1],t.settlementService=r[2].trim(),t.pageNumber=parseInt(r[3]),t.lineNumber=s+1;return}let e=o.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s{2,}([A-Z\s]+SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i);if(e||(e=o.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*?)\s+([A-Z]+\s+(?:[A-Z]+\s+)*SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i)),e){t.reportingFor=e[1],t.reportingForName=e[2].trim().replace(/\s+/g," "),t.settlementService=e[3].trim(),t.processingDate=e[4].trim();return}let n=o.match(/ROLLUP\s+TO:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s+(SETTLEMENT\s+SUMMARY\s+REPORT|SRE\s+SETTLEMENT\s+RECAP\s+REPORT)\s+REPORT\s+DATE:\s+(\S+)\s*$/i);if(n){t.rollupTo=n[1],t.rollupToName=n[2].trim().replace(/\s+/g," "),t.reportTitle=n[3].trim(),t.reportDate=n[4].trim();return}const u=o.match(/FUNDS\s+(?:XFER|TRANSFER)\s+ENTITY:\s+(\d+)\s+(.+?)\s*$/i);if(u){t.fundsTransferEntity=u[1],t.fundsTransferEntityName=u[2].trim();return}const m=o.match(/SETTLEMENT\s+CURRENCY:\s+([A-Z]{3})/i);if(m){t.settlementCurrency=m[1];return}const l=o.match(/CLEARING\s+CURRENCY:\s+([A-Z]{3})/i);if(l){t.clearingCurrency=l[1];return}const c=o.match(/FOR\s+(.+?)\s+THROUGH\s+(.+?)(?:\s+LAST\s+CHANGE:\s+(.+?))?$/i);if(c){t.forDate=c[1].trim(),t.throughDate=c[2].trim(),c[3]&&(t.lastChange=c[3].trim());return}}),t}function P(i){if(/^\s*(TOTAL|REIMBURSEMENT|VISA|FINAL)/i.test(i))return null;const a=/^\s*([A-Z][A-Z\s\-]+?)\s{2,}(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)\s+(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)\s+(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=i.match(a);if(!t)return null;const o=t[1].trim(),s=t[2]?parseInt(t[2].replace(/,/g,"")):0,r=E(t[3]),e=t[4]?parseInt(t[4].replace(/,/g,"")):0,n=E(t[5]),u=t[6]?parseInt(t[6].replace(/,/g,"")):0,m=E(t[7]),l=t[8];return{name:o,creditsCount:s,creditsAmount:r,debitsCount:e,debitsAmount:n,totalCount:u,totalAmount:l==="DB"?-m:m}}function V(i){const a=/^\s*(?:TOTAL\s+INTERCHANGE|TOTAL\s+ACQUIRER|TOTAL\s+ISSUER|TOTAL\s+OTHER|TOTAL)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=/^\s*(?:REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,o=/^\s*FINAL\s+SETTLEMENT\s+NET\s+AMOUNT\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i;let s=i.match(a);return s?{creditsCount:parseInt(s[1].replace(/,/g,"")),creditsAmount:E(s[2]),debitsCount:parseInt(s[3].replace(/,/g,"")),debitsAmount:E(s[4]),totalCount:parseInt(s[5].replace(/,/g,"")),totalAmount:s[7]==="DB"?-E(s[6]):E(s[6])}:(s=i.match(t),s?{creditsAmount:E(s[1]),debitsAmount:E(s[2]),totalAmount:s[4]==="DB"?-E(s[3]):E(s[3])}:(s=i.match(o),s?{creditsAmount:0,debitsAmount:0,totalAmount:s[2]==="DB"?-E(s[1]):E(s[1])}:null))}function v(i){const a=i.split(`
`),t={acquirerTransactions:{transactionTypes:[],totalInterchange:{creditsAmount:0,debitsAmount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalAcquirer:{creditsAmount:0,debitsAmount:0,totalAmount:0}},issuerTransactions:{transactionTypes:[],totalInterchange:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalIssuer:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0}},otherTransactions:{transactionTypes:[],totalInterchange:{creditsAmount:0,debitsAmount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalOther:{creditsAmount:0,debitsAmount:0,totalAmount:0}},total:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0},finalSettlementNetAmount:{amount:0,type:"CR"}};let o="";for(let s=0;s<a.length;s++){const r=a[s];if(/^\s*ACQUIRER\s+TRANSACTIONS\s*$/i.test(r)){o="ACQUIRER";continue}if(/^\s*ISSUER\s+TRANSACTIONS\s*$/i.test(r)){o="ISSUER";continue}if(/^\s*OTHER\s+TRANSACTIONS\s*$/i.test(r)){o="OTHER";continue}const e=P(r);if(e){o==="ACQUIRER"?t.acquirerTransactions.transactionTypes.push(e):o==="ISSUER"?t.issuerTransactions.transactionTypes.push(e):o==="OTHER"&&t.otherTransactions.transactionTypes.push(e);continue}const n=V(r);if(n){if(/^\s*TOTAL\s+\d/i.test(r)&&!/TOTAL\s+(INTERCHANGE|ACQUIRER|ISSUER|OTHER)/i.test(r)&&n.creditsCount!==void 0&&n.totalCount!==void 0){t.total={creditsCount:n.creditsCount,creditsAmount:n.creditsAmount,debitsCount:n.debitsCount||0,debitsAmount:n.debitsAmount,totalCount:n.totalCount,totalAmount:n.totalAmount};continue}if(o==="ACQUIRER"?/TOTAL\s+INTERCHANGE/i.test(r)?t.acquirerTransactions.totalInterchange={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(r)?t.acquirerTransactions.reimbursementFees={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/VISA\s+CHARGES/i.test(r)?t.acquirerTransactions.visaCharges={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/TOTAL\s+ACQUIRER/i.test(r)&&(t.acquirerTransactions.totalAcquirer={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}):o==="ISSUER"?/TOTAL\s+INTERCHANGE/i.test(r)?t.issuerTransactions.totalInterchange={creditsCount:n.creditsCount||0,creditsAmount:n.creditsAmount,debitsCount:n.debitsCount||0,debitsAmount:n.debitsAmount,totalCount:n.totalCount||0,totalAmount:n.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(r)?t.issuerTransactions.reimbursementFees={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/VISA\s+CHARGES/i.test(r)?t.issuerTransactions.visaCharges={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/TOTAL\s+ISSUER/i.test(r)&&(t.issuerTransactions.totalIssuer={creditsCount:n.creditsCount||0,creditsAmount:n.creditsAmount,debitsCount:n.debitsCount||0,debitsAmount:n.debitsAmount,totalCount:n.totalCount||0,totalAmount:n.totalAmount}):o==="OTHER"&&(/TOTAL\s+INTERCHANGE/i.test(r)?t.otherTransactions.totalInterchange={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(r)?t.otherTransactions.reimbursementFees={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/VISA\s+CHARGES/i.test(r)?t.otherTransactions.visaCharges={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/TOTAL\s+OTHER/i.test(r)&&(t.otherTransactions.totalOther={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount})),/FINAL\s+SETTLEMENT\s+NET\s+AMOUNT/i.test(r)){const u=r.match(/FINAL\s+SETTLEMENT\s+NET\s+AMOUNT\s+([\d,]+\.?\d*)(CR|DB)?/i);if(u){const m=E(u[1]);t.finalSettlementNetAmount={amount:u[2]==="DB"?-m:m,type:u[2]||"CR"}}}}}return t}function $(i){const a=U(i),t=v(i);return{reportType:"VSS-115",header:a,data:t,rawContent:i}}function w(i){return/REPORT\s+ID:\s+VSS-115/i.test(i)&&/SRE\s+SETTLEMENT\s+RECAP\s+REPORT/i.test(i)}function B(i){return i.split(/(?=REPORT\s+ID:)/i).map(t=>t.trim()).filter(t=>t.length>0&&/REPORT\s+ID:/i.test(t))}function C(i){return F(i)?"VSS-110":w(i)?"VSS-115":/REPORT\s+ID:\s*SMS6/i.test(i)?"SMS":"UNKNOWN"}function H(i,a){const t={smsReports:[],vssReports:[],totalSMSReports:0,totalVSSReports:0,totalTransactions:0,errors:[]},s=i.split(`
`).length;a?.({status:"parsing",currentLine:0,totalLines:s,smsReportsFound:0,vssReportsFound:0,transactionsParsed:0,message:"Starting to parse reports..."});try{const r=B(i);let e=[];const n=[];for(const u of r){const m=C(u);m==="SMS"?e.push(u):(m==="VSS-110"||m==="VSS-115")&&n.push(u)}if(e.length>0){const u=e.join(`

`),m=M(u,l=>{a?.({status:"parsing",currentLine:l.currentLine,totalLines:l.totalLines,smsReportsFound:l.reportsFound,vssReportsFound:n.length,transactionsParsed:l.transactionsParsed,message:`Parsing SMS reports: ${l.reportsFound} found, ${l.transactionsParsed} transactions`})});t.smsReports=m.reports,t.totalSMSReports=t.smsReports.length,t.totalTransactions=t.smsReports.reduce((l,c)=>l+c.transactions.length,0)}for(const u of n)try{const m=C(u);if(m==="VSS-110"){const l=y(u);t.vssReports.push(l),t.totalVSSReports++}else if(m==="VSS-115"){const l=$(u);t.vssReports.push(l),t.totalVSSReports++}a?.({status:"parsing",currentLine:s,totalLines:s,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Parsed ${t.totalSMSReports} SMS reports and ${t.totalVSSReports} VSS reports`})}catch(m){const l=m instanceof Error?m.message:"Unknown error";t.errors.push(`Error parsing VSS report: ${l}`)}a?.({status:"completed",currentLine:s,totalLines:s,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Parsing complete: ${t.totalSMSReports} SMS reports, ${t.totalVSSReports} VSS reports`})}catch(r){const e=r instanceof Error?r.message:"Unknown error";t.errors.push(`Fatal error during parsing: ${e}`),a?.({status:"error",currentLine:0,totalLines:s,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:e})}return t}function G(i,a){const t={smsReports:[],vssReports:[],totalSMSReports:0,totalVSSReports:0,totalTransactions:0,errors:[]};for(let o=0;o<i.length;o++){const s=i[o];a?.({status:"parsing",currentLine:o,totalLines:i.length,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Processing file ${o+1} of ${i.length}: ${s.name}`});try{const r=H(s.content,e=>{a?.({...e,message:`[${s.name}] ${e.message}`})});t.smsReports.push(...r.smsReports),t.vssReports.push(...r.vssReports),t.totalSMSReports+=r.totalSMSReports,t.totalVSSReports+=r.totalVSSReports,t.totalTransactions+=r.totalTransactions,t.errors.push(...r.errors)}catch(r){const e=r instanceof Error?r.message:"Unknown error";t.errors.push(`Error parsing file ${s.name}: ${e}`)}}return a?.({status:"completed",currentLine:i.length,totalLines:i.length,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`All files processed: ${t.totalSMSReports} SMS reports, ${t.totalVSSReports} VSS reports from ${i.length} file(s)`}),t}self.onmessage=i=>{const{type:a,payload:t}=i.data;if(a==="parse")try{const o=G(t.files,s=>{self.postMessage({type:"progress",payload:s})});self.postMessage({type:"result",payload:o})}catch(o){self.postMessage({type:"error",payload:{message:o instanceof Error?o.message:"Unknown parsing error"}})}}})();
