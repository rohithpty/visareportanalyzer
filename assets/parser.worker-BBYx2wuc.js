(function(){"use strict";const T={reportId:/REPORT ID:\s*(SMS6\d+[A-Z]?)/i,pageNumber:/PAGE NUMBER\s*:\s*(\d+)/i,fundsTransfer:/FUNDS XFR:\s*(\d+)\s+(.+?)\s{2,}/i,processor:/PROCESSOR:\s*(\d+)\s+(.+?)\s{2,}/i,affiliate:/AFFILIATE:\s*(\d+)\s+(.+?)\s{2,}/i,sre:/SRE\s*:\s*(\d+)\s+(.+?)\s{2,}/i,onlineSettlementDate:/ONLINE SETTLMNT DATE:\s*(\d{2}\w{3}\d{2})/i,runDate:/(RUN DATE|REPORT DATE)\s*:\s*(\d{2}\w{3}\d{2})/i,runTime:/(RUN TIME|REPORT TIME)\s*:\s*(\d{2}:\d{2}:\d{2})/i,vssProcessingDate:/VSS PROCESSING DATE\s*:\s*(\d{2}\w{3}\d{2})/i,settlementCurrency:/AMOUNT\s*\(([A-Z]{3})\)/i,nationalNet:/NATIONAL NET/i,transactionLine1:/^\s*(\d+)\s+(\d{2}\w{3})\s+(\d{2}:\d{2}:\d{2})\s+([\dxX]+)\s+(\S+)\s+(\d+)\s+(\d+)\s+(\d{4})\s+(\d{6})\s+(\d+(?:\.\d{2})?)\s+(\d+(?:\.\d{2})?)\s+(\d+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)\s+([A-Z]{3})\s+([\d,]+(?:\.\d{2})?)\s*(?:(CR|DR))?\s*$/i,transactionLine1Extended:/^\s*(\d+)\s+(\d{2}\w{3})\s+(\d{2}:\d{2}:\d{2})\s+([\dxX]+)\s+(\S+)\s+(\d+)\s+(\d+)\s+(\d{4})\s+(\d{6})\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([A-Z]{3})\s+([\d,]+(?:\.\d{2})?)\s*(?:(CR|DR))?\s*$/i,transactionLine1SMS612:/^\s*(\d+)\s+(\d{2}\w{3})\s+(\d{2}:\d{2}:\d{2})\s+([\dxX]+)\s+(\S+)\s+(\d+)\s+(\d+)\s+(\d{4})\s+(\d{6})\s+(\d+)\s+(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([A-Z]{3})\s+([\d,]+(?:\.\d{2})?)\s*(?:(CR|DR))?\s*$/i,transactionLine2:/^\s*(\d{4}|\d{2}\w{3})?\s*(\d{2}:\d{2}:\d{2})?\s*CA ID:\s*(\S+)?\s+(\S+)?\s+(\d+)?\s+(\d{2})?\/(.+)\/([A-Z]{2})(?:\s+(\d{4}))?/i,transactionLine3CDSQ:/CD SQ:\s*(\d+)\s+ATC:\s*(\w+)(?:\s+CI:\s*(\d+))?(?:\s+M\/EC:\s*(\w+))?(?:\s+AP:\s*(\w+))?/i,transactionLine3ATC:/ATC:\s*(\w+)(?:\s+CI:\s*(\d+))?(?:\s+M\/EC:\s*(\w+))?/i,transactionLine4Usage:/USAGE:\s*(\w+)\s+TR ID:\s*([\w\/]+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?(?:\s+PTS:\s*([\w\s]+))?(?:\s+PMC:\s*(\w+))?(?:\s+SCHG:\s*([\d,\.]+))?/i,transactionLine4DgCd:/DG CD:\s*(\w+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?/i,transactionLine4TrId:/TR ID:\s*([\w\/]+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?/i,transactionLine5:/FEE JURIS:\s*(.+?)\s+ROUTING:\s*(.+?)\s+FEE LEVEL:\s*(.+?)\s+([\d,\.]+)(CR|DR)?/i,transactionLine5RoutingOnly:/ROUTING:\s*(.+?)(?:\s+FEE LEVEL:|\s*$)/i,feeJuris:/FEE JURIS:/i,fpi:/FPI:\s*(\w+)/i,affiliateSummary:/AFFILIATE ID:\s*(\d+)\s+(.+?)(?:,|\s{2,})/i,debitsLine:/DEBITS\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})DR/i,creditsLine:/CREDITS\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})CR/i,totalLine:/TOTAL\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})(CR|DR)/i,subtotalLine:/SUBTOTAL\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})(CR|DR)/i,nonFinancialLine:/NON FINANCIAL\s*:\s*(\d+)/i,totalFeesLine:/TOTAL FEES\s*:\s*(\d+)/i,debitsLineExtended:/DEBITS\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,creditsLineExtended:/CREDITS\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,subtotalLineExtended:/SUBTOTAL\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,totalFeesLineExtended:/TOTAL FEES\s*:\s*(\d+)\s+([\d,.]+)(CR|DR)/i},I={"00":"Purchase/Sale","01":"Cash Advance","09":"Purchase with Cashback",10:"Financial Cash Withdrawal",11:"Cash Transaction Reversal",20:"Balance Inquiry",22:"Purchase Refund",26:"Cash Advance Refund",30:"Funds Transfer",31:"Utility Payment",40:"Cardholder Account Transfer",50:"ATM Withdrawal",51:"PIN Unblock",90:"Administrative Message"},h={"00":"Not Specified / Not Applicable",10:"Savings Account",20:"Checking Account (Current Account)",30:"Credit Card Account",40:"Universal Account",50:"Investment Account",60:"Bonus Account"};function S(a){if(!/^\d{6}$/.test(a))return;const o=a.substring(0,2),t=a.substring(2,4),n=a.substring(4,6);return{transactionType:o,transactionTypeDescription:I[o]||`Unknown (${o})`,fromAccountType:t,fromAccountTypeDescription:h[t]||`Unknown (${t})`,toAccountType:n,toAccountTypeDescription:h[n]||`Unknown (${n})`}}function N(a){let o={};for(let t=0;t<Math.min(20,a.length);t++){const n=a[t],r=n.match(T.reportId),s=n.match(T.pageNumber),i=n.match(T.fundsTransfer),e=n.match(T.processor),l=n.match(T.affiliate),d=n.match(T.sre),m=n.match(T.onlineSettlementDate),c=n.match(T.runDate),A=n.match(T.runTime),u=n.match(T.vssProcessingDate),R=n.match(T.settlementCurrency);r&&(o.reportId=r[1]),s&&(o.pageNumber=parseInt(s[1])),i&&(o.fundsTransferSRE=i[1],o.fundsTransferName=i[2].trim()),e&&(o.processor=e[1],o.processorName=e[2].trim()),l&&(o.affiliate=l[1],o.affiliateName=l[2].trim()),d&&(o.sre=d[1],o.sreName=d[2].trim()),m&&(o.onlineSettlementDate=m[1]),c&&(o.runDate=c[2]),A&&(o.runTime=A[2]),u&&(o.vssProcessingDate=u[1]),R&&(o.settlementCurrency=R[1]),T.nationalNet.test(n)&&(o.nationalNet=!0)}if(o.settlementCurrency||(o.settlementCurrency="USD"),o.sreName){const t=o.sreName.match(/^(\d{6,8})/);if(t){let n=t[1];o.bin=n}}if(!o.bin&&o.affiliate){const t=o.affiliate.substring(0,8);if(/^\d{8}$/.test(t)){let n=t;n.length===8&&n.endsWith("00")&&(n=n.substring(0,6)),o.bin=n}}return o.reportId?o:null}function g(a,o){const t=[];let n=0;for(;n<a.length;){const r=a[n].trim();let s=r.match(T.transactionLine1Extended),i=!!s,e=!1;if(s||(s=r.match(T.transactionLine1SMS612),e=!!s),s||(s=r.match(T.transactionLine1)),s){let l=s[4];const d=/[xX]/.test(l);let m=l;m.length===16?m=l:m.length===19&&m.endsWith("000")?m=l.substring(0,16):m.length>16&&m.endsWith("000")&&(m=m.substring(0,m.length-3));let c;if(i){const A=s[9],u=S(A);c={batchNumber:s[1],transmitDate:s[2],transmitTime:s[3],cardNumber:m,masked:d||void 0,retrievalRefNumber:s[5],traceNumber:s[6],acquirerId:s[7],transactionType:s[8],processingCode:A,processingCodeParsed:u,transactionSubtype:u?.transactionTypeDescription,entryMode:s[10],reasonCode:s[11],conditionCode:s[12],responseCode:s[13],cardholderBillingAmount:s[14],cardholderBillingCurrency:s[15],settlementAmount:s[16],settlementCurrency:o.settlementCurrency,settlementType:s[17]||"DR"}}else if(e){const A=s[9],u=S(A);c={batchNumber:s[1],transmitDate:s[2],transmitTime:s[3],cardNumber:m,masked:d||void 0,retrievalRefNumber:s[5],traceNumber:s[6],acquirerId:s[7],transactionType:s[8],processingCode:A,processingCodeParsed:u,transactionSubtype:u?.transactionTypeDescription,reasonCode:s[10],responseCode:s[11],cardholderBillingAmount:s[12],cardholderBillingCurrency:s[13],settlementAmount:s[14],settlementCurrency:o.settlementCurrency,settlementType:s[15]||"DR"}}else{const A=s[9],u=S(A);c={batchNumber:s[1],transmitDate:s[2],transmitTime:s[3],cardNumber:m,masked:d||void 0,retrievalRefNumber:s[5],traceNumber:s[6],acquirerId:s[7],transactionType:s[8],processingCode:A,processingCodeParsed:u,transactionSubtype:u?.transactionTypeDescription,entryMode:s[10],reasonCode:s[11],responseCode:s[12],cardholderBillingAmount:s[13],cardholderBillingCurrency:s[14],settlementAmount:s[15],settlementCurrency:o.settlementCurrency,settlementType:s[16]||"DR"}}if(n++,n<a.length&&a[n].includes("CA ID:")){const A=a[n],u=A.match(T.transactionLine2);u&&(u[3]&&(c.cardAcceptorTerminalId=u[3]),u[4]&&(c.cardAcceptorId=u[4]),u[7]&&(c.merchantName=u[7].trim()),u[8]&&(c.merchantCountryCode=u[8]));const R=A.match(T.fpi);R&&(c.feeProgramIndicator=R[1]),n++}if(n<a.length){const A=a[n];(A.match(T.transactionLine3CDSQ)||A.match(T.transactionLine3ATC)||A.includes("M/EC:"))&&n++}if(n<a.length){const A=a[n],u=A.match(T.transactionLine4Usage);if(u)c.usage=u[1],c.transactionIdentifier=u[2],u[3]&&(c.authCharIndicator=u[3]),u[4]&&(c.validationCode=u[4]),n++;else{const R=A.match(T.transactionLine4DgCd);if(R)c.downgradeCode=R[1],R[2]&&(c.authCharIndicator=R[2]),R[3]&&(c.validationCode=R[3]),n++;else{const f=A.match(T.transactionLine4TrId);f&&(c.transactionIdentifier=f[1],f[2]&&(c.authCharIndicator=f[2]),f[3]&&(c.validationCode=f[3]),n++)}}}if(n<a.length){const A=a[n];if(T.feeJuris.test(A)){const u=A.match(T.transactionLine5);u&&(c.feeJurisdiction=u[1].trim(),c.routing=u[2].trim(),c.feeLevel=u[3].trim(),u[4]&&(c.feeAmount=u[4],u[5]&&(c.feeType=u[5]))),n++}else if(A.includes("ROUTING:")){const u=A.match(T.transactionLine5RoutingOnly);u&&(c.routing=u[1].trim()),n++}}t.push(c)}else n++}return t}function b(a){let o={};for(const t of a){const n=t.match(T.affiliateSummary),r=t.match(T.debitsLine),s=t.match(T.creditsLine),i=t.match(T.totalLine),e=t.match(T.subtotalLine),l=t.match(T.nonFinancialLine),d=t.match(T.totalFeesLine),m=t.match(T.debitsLineExtended),c=t.match(T.creditsLineExtended),A=t.match(T.subtotalLineExtended),u=t.match(T.totalFeesLineExtended);if(n&&(o.affiliateId=n[1],o.affiliateName=n[2].trim()),m?(o.debitsCount=parseInt(m[1]),o.debitsAmount=m[3],o.debits={count:parseInt(m[1]),billingAmount:m[2],settlementAmount:m[3],settlementType:m[4]}):r&&(o.debitsCount=parseInt(r[1]),o.debitsAmount=r[3]),c?(o.creditsCount=parseInt(c[1]),o.creditsAmount=c[3],o.credits={count:parseInt(c[1]),billingAmount:c[2],settlementAmount:c[3],settlementType:c[4]}):s&&(o.creditsCount=parseInt(s[1]),o.creditsAmount=s[3]),A)o.totalCount=parseInt(A[1]),o.totalAmount=A[3],o.totalType=A[4],o.subtotal={count:parseInt(A[1]),billingAmount:A[2],settlementAmount:A[3],settlementType:A[4]};else if(i||e){const R=i||e;R&&(o.totalCount=parseInt(R[1]),o.totalAmount=R[3],o.totalType=R[4])}l&&(o.nonFinancialCount=parseInt(l[1])),u?(o.totalFeesCount=parseInt(u[1]),o.totalFeesAmount=u[2],o.totalFees={count:parseInt(u[1]),amount:u[2],type:u[3]}):d&&(o.totalFeesCount=parseInt(d[1]))}return o.affiliateId?o:null}function M(a,o,t){const n=[],r={status:"parsing",currentLine:0,totalLines:0,reportsFound:0,transactionsParsed:0};let s=0,i=0;try{for(const l of a){const d=l.split(`
`),m=N(d);if(m){const c=g(d,m),A=b(d);for(const R of c)R.settlementType==="DR"?s++:R.settlementType==="CR"&&i++;const u={header:m,transactions:c,summary:A||void 0,...t?.includeRawContent&&{rawContent:l}};n.push(u),r.reportsFound++,r.transactionsParsed+=c.length,(r.transactionsParsed%100===0||r.reportsFound%10===0)&&o?.(r)}}r.status="completed",o?.(r);const e={totalReports:n.length,totalTransactions:r.transactionsParsed,totalDebits:s,totalCredits:i};return{reports:n,progress:r,summary:e}}catch(e){throw r.status="error",r.errorMessage=e instanceof Error?e.message:"Unknown error",o?.(r),e}}function E(a){const o=a.replace(/,/g,"").trim();return parseFloat(o)||0}function L(a){const o=/^\s*TOTAL\s+(?:ACQUIRER|ISSUER|OTHER|INTERCHANGE\s+VALUE|REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=/^\s*TOTAL\s+(?:ACQUIRER|ISSUER|OTHER|INTERCHANGE\s+VALUE|REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,n=/^\s*NET\s+SETTLEMENT\s+AMOUNT\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i;let r=a.match(o);if(r){const s=parseInt(r[1].replace(/,/g,"")),i=E(r[2]),e=E(r[3]),l=E(r[4]);return{count:s,creditAmount:i,debitAmount:e,totalAmount:r[5]==="DB"?-l:l}}if(r=a.match(t),r){const s=E(r[1]),i=E(r[2]),e=E(r[3]);return{creditAmount:s,debitAmount:i,totalAmount:r[4]==="DB"?-e:e}}if(r=a.match(n),r){const s=E(r[1]),i=E(r[2]),e=E(r[3]);return{creditAmount:s,debitAmount:i,totalAmount:r[4]==="DB"?-e:e}}return null}function O(a){const o=a.split(`
`),t={reportId:"",pageNumber:1,reportingFor:"",reportingForName:"",rollupTo:"",rollupToName:"",fundsTransferEntity:"",fundsTransferEntityName:"",settlementService:"",reportTitle:"",settlementCurrency:"",processingDate:"",reportDate:""};return o.forEach((n,r)=>{const s=n.match(/REPORT\s+ID:\s+(VSS-\d+)\s+(.+?)\s+PAGE:\s+(\d+)/i);if(s){t.reportId=s[1],t.settlementService=s[2].trim(),t.pageNumber=parseInt(s[3]),t.lineNumber=r+1;return}let i=n.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s{2,}([A-Z\s]+SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i);if(i||(i=n.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*?)\s+([A-Z]+\s+(?:[A-Z]+\s+)*SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i)),i){t.reportingFor=i[1],t.reportingForName=i[2].trim().replace(/\s+/g," "),t.settlementService=i[3].trim(),t.processingDate=i[4].trim();return}let e=n.match(/ROLLUP\s+TO:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s+(SETTLEMENT\s+SUMMARY\s+REPORT|SRE\s+SETTLEMENT\s+RECAP\s+REPORT)\s+REPORT\s+DATE:\s+(\S+)\s*$/i);if(e){t.rollupTo=e[1],t.rollupToName=e[2].trim().replace(/\s+/g," "),t.reportTitle=e[3].trim(),t.reportDate=e[4].trim();return}const l=n.match(/FUNDS\s+(?:XFER|TRANSFER)\s+ENTITY:\s+(\d+)\s+(.+?)\s*$/i);if(l){t.fundsTransferEntity=l[1],t.fundsTransferEntityName=l[2].trim();return}const d=n.match(/SETTLEMENT\s+CURRENCY:\s+([A-Z]{3})/i);if(d){t.settlementCurrency=d[1];return}const m=n.match(/CLEARING\s+CURRENCY:\s+([A-Z]{3})/i);if(m){t.clearingCurrency=m[1];return}const c=n.match(/FOR\s+(.+?)\s+THROUGH\s+(.+?)(?:\s+LAST\s+CHANGE:\s+(.+?))?$/i);if(c){t.forDate=c[1].trim(),t.throughDate=c[2].trim(),c[3]&&(t.lastChange=c[3].trim());return}}),t}function y(a){const o=a.split(`
`),t={interchangeValue:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},reimbursementFees:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},visaCharges:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},total:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},netSettlementAmount:{creditAmount:0,debitAmount:0,totalAmount:0}}},n=a.match(/FUNDS\s+TRANSFER\s+AMOUNT:\s+([\d,]+\.?\d*)(CR|DB)?/i);if(n){const s=E(n[1]);t.fundsTransferAmount={amount:n[2]==="DB"?-s:s,type:n[2]||"CR"}}let r="";for(let s=0;s<o.length;s++){const i=o[s];if(/^\s*INTERCHANGE\s+VALUE\s*$/i.test(i)){r="INTERCHANGE_VALUE";continue}if(/^\s*REIMBURSEMENT\s+FEES\s*$/i.test(i)){r="REIMBURSEMENT_FEES";continue}if(/^\s*VISA\s+CHARGES\s*$/i.test(i)){r="VISA_CHARGES";continue}if(/^\s*TOTAL\s*$/i.test(i)&&!i.match(/TOTAL\s+(ACQUIRER|ISSUER|OTHER)/i)){r="TOTAL";continue}const e=L(i);e&&(r==="INTERCHANGE_VALUE"?/TOTAL\s+ACQUIRER/i.test(i)?t.interchangeValue.totalAcquirer=e:/TOTAL\s+ISSUER/i.test(i)?t.interchangeValue.totalIssuer=e:/TOTAL\s+OTHER/i.test(i)?t.interchangeValue.totalOther=e:/TOTAL\s+INTERCHANGE\s+VALUE/i.test(i)&&(t.interchangeValue.total=e):r==="REIMBURSEMENT_FEES"?/TOTAL\s+ACQUIRER/i.test(i)?t.reimbursementFees.totalAcquirer=e:/TOTAL\s+ISSUER/i.test(i)?t.reimbursementFees.totalIssuer=e:/TOTAL\s+OTHER/i.test(i)?t.reimbursementFees.totalOther=e:/TOTAL\s+REIMBURSEMENT\s+FEES/i.test(i)&&(t.reimbursementFees.total=e):r==="VISA_CHARGES"?/TOTAL\s+ACQUIRER/i.test(i)?t.visaCharges.totalAcquirer=e:/TOTAL\s+ISSUER/i.test(i)?t.visaCharges.totalIssuer=e:/TOTAL\s+OTHER/i.test(i)?t.visaCharges.totalOther=e:/TOTAL\s+VISA\s+CHARGES/i.test(i)&&(t.visaCharges.total=e):r==="TOTAL"&&(/TOTAL\s+ACQUIRER/i.test(i)?t.total.totalAcquirer=e:/TOTAL\s+ISSUER/i.test(i)?t.total.totalIssuer=e:/TOTAL\s+OTHER/i.test(i)?t.total.totalOther=e:/NET\s+SETTLEMENT\s+AMOUNT/i.test(i)&&(t.total.netSettlementAmount=e)))}return t}function D(a){const o=O(a),t=y(a);return{reportType:"VSS-110",header:o,data:t,rawContent:a}}function F(a){return/REPORT\s+ID:\s+VSS-110/i.test(a)&&/SETTLEMENT\s+SUMMARY\s+REPORT/i.test(a)}function p(a){const o=a.replace(/,/g,"").trim();return parseFloat(o)||0}function U(a){const o=a.split(`
`),t={reportId:"",pageNumber:1,reportingFor:"",reportingForName:"",rollupTo:"",rollupToName:"",fundsTransferEntity:"",fundsTransferEntityName:"",settlementService:"",reportTitle:"",settlementCurrency:"",processingDate:"",reportDate:""};return o.forEach((n,r)=>{const s=n.match(/REPORT\s+ID:\s+(VSS-\d+)\s+(.+?)\s+PAGE:\s+(\d+)/i);if(s){t.reportId=s[1],t.settlementService=s[2].trim(),t.pageNumber=parseInt(s[3]),t.lineNumber=r+1;return}let i=n.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s{2,}([A-Z\s]+SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i);if(i||(i=n.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*?)\s+([A-Z]+\s+(?:[A-Z]+\s+)*SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i)),i){t.reportingFor=i[1],t.reportingForName=i[2].trim().replace(/\s+/g," "),t.settlementService=i[3].trim(),t.processingDate=i[4].trim();return}let e=n.match(/ROLLUP\s+TO:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s+(SETTLEMENT\s+SUMMARY\s+REPORT|SRE\s+SETTLEMENT\s+RECAP\s+REPORT)\s+REPORT\s+DATE:\s+(\S+)\s*$/i);if(e){t.rollupTo=e[1],t.rollupToName=e[2].trim().replace(/\s+/g," "),t.reportTitle=e[3].trim(),t.reportDate=e[4].trim();return}const l=n.match(/FUNDS\s+(?:XFER|TRANSFER)\s+ENTITY:\s+(\d+)\s+(.+?)\s*$/i);if(l){t.fundsTransferEntity=l[1],t.fundsTransferEntityName=l[2].trim();return}const d=n.match(/SETTLEMENT\s+CURRENCY:\s+([A-Z]{3})/i);if(d){t.settlementCurrency=d[1];return}const m=n.match(/CLEARING\s+CURRENCY:\s+([A-Z]{3})/i);if(m){t.clearingCurrency=m[1];return}const c=n.match(/FOR\s+(.+?)\s+THROUGH\s+(.+?)(?:\s+LAST\s+CHANGE:\s+(.+?))?$/i);if(c){t.forDate=c[1].trim(),t.throughDate=c[2].trim(),c[3]&&(t.lastChange=c[3].trim());return}}),t}function P(a){if(/^\s*(TOTAL|REIMBURSEMENT|VISA|FINAL)/i.test(a))return null;const o=/^\s*([A-Z][A-Z\s\-]+?)\s{2,}(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)\s+(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)\s+(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=a.match(o);if(!t)return null;const n=t[1].trim(),r=t[2]?parseInt(t[2].replace(/,/g,"")):0,s=p(t[3]),i=t[4]?parseInt(t[4].replace(/,/g,"")):0,e=p(t[5]),l=t[6]?parseInt(t[6].replace(/,/g,"")):0,d=p(t[7]),m=t[8];return{name:n,creditsCount:r,creditsAmount:s,debitsCount:i,debitsAmount:e,totalCount:l,totalAmount:m==="DB"?-d:d}}function V(a){const o=/^\s*(?:TOTAL\s+INTERCHANGE|TOTAL\s+ACQUIRER|TOTAL\s+ISSUER|TOTAL\s+OTHER|TOTAL)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=/^\s*(?:REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,n=/^\s*FINAL\s+SETTLEMENT\s+NET\s+AMOUNT\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i;let r=a.match(o);return r?{creditsCount:parseInt(r[1].replace(/,/g,"")),creditsAmount:p(r[2]),debitsCount:parseInt(r[3].replace(/,/g,"")),debitsAmount:p(r[4]),totalCount:parseInt(r[5].replace(/,/g,"")),totalAmount:r[7]==="DB"?-p(r[6]):p(r[6])}:(r=a.match(t),r?{creditsAmount:p(r[1]),debitsAmount:p(r[2]),totalAmount:r[4]==="DB"?-p(r[3]):p(r[3])}:(r=a.match(n),r?{creditsAmount:0,debitsAmount:0,totalAmount:r[2]==="DB"?-p(r[1]):p(r[1])}:null))}function v(a){const o=a.split(`
`),t={acquirerTransactions:{transactionTypes:[],totalInterchange:{creditsAmount:0,debitsAmount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalAcquirer:{creditsAmount:0,debitsAmount:0,totalAmount:0}},issuerTransactions:{transactionTypes:[],totalInterchange:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalIssuer:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0}},otherTransactions:{transactionTypes:[],totalInterchange:{creditsAmount:0,debitsAmount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalOther:{creditsAmount:0,debitsAmount:0,totalAmount:0}},total:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0},finalSettlementNetAmount:{amount:0,type:"CR"}};let n="";for(let r=0;r<o.length;r++){const s=o[r];if(/^\s*ACQUIRER\s+TRANSACTIONS\s*$/i.test(s)){n="ACQUIRER";continue}if(/^\s*ISSUER\s+TRANSACTIONS\s*$/i.test(s)){n="ISSUER";continue}if(/^\s*OTHER\s+TRANSACTIONS\s*$/i.test(s)){n="OTHER";continue}const i=P(s);if(i){n==="ACQUIRER"?t.acquirerTransactions.transactionTypes.push(i):n==="ISSUER"?t.issuerTransactions.transactionTypes.push(i):n==="OTHER"&&t.otherTransactions.transactionTypes.push(i);continue}const e=V(s);if(e){if(/^\s*TOTAL\s+\d/i.test(s)&&!/TOTAL\s+(INTERCHANGE|ACQUIRER|ISSUER|OTHER)/i.test(s)&&e.creditsCount!==void 0&&e.totalCount!==void 0){t.total={creditsCount:e.creditsCount,creditsAmount:e.creditsAmount,debitsCount:e.debitsCount||0,debitsAmount:e.debitsAmount,totalCount:e.totalCount,totalAmount:e.totalAmount};continue}if(n==="ACQUIRER"?/TOTAL\s+INTERCHANGE/i.test(s)?t.acquirerTransactions.totalInterchange={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(s)?t.acquirerTransactions.reimbursementFees={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}:/VISA\s+CHARGES/i.test(s)?t.acquirerTransactions.visaCharges={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}:/TOTAL\s+ACQUIRER/i.test(s)&&(t.acquirerTransactions.totalAcquirer={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}):n==="ISSUER"?/TOTAL\s+INTERCHANGE/i.test(s)?t.issuerTransactions.totalInterchange={creditsCount:e.creditsCount||0,creditsAmount:e.creditsAmount,debitsCount:e.debitsCount||0,debitsAmount:e.debitsAmount,totalCount:e.totalCount||0,totalAmount:e.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(s)?t.issuerTransactions.reimbursementFees={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}:/VISA\s+CHARGES/i.test(s)?t.issuerTransactions.visaCharges={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}:/TOTAL\s+ISSUER/i.test(s)&&(t.issuerTransactions.totalIssuer={creditsCount:e.creditsCount||0,creditsAmount:e.creditsAmount,debitsCount:e.debitsCount||0,debitsAmount:e.debitsAmount,totalCount:e.totalCount||0,totalAmount:e.totalAmount}):n==="OTHER"&&(/TOTAL\s+INTERCHANGE/i.test(s)?t.otherTransactions.totalInterchange={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(s)?t.otherTransactions.reimbursementFees={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}:/VISA\s+CHARGES/i.test(s)?t.otherTransactions.visaCharges={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount}:/TOTAL\s+OTHER/i.test(s)&&(t.otherTransactions.totalOther={creditsAmount:e.creditsAmount,debitsAmount:e.debitsAmount,totalAmount:e.totalAmount})),/FINAL\s+SETTLEMENT\s+NET\s+AMOUNT/i.test(s)){const l=s.match(/FINAL\s+SETTLEMENT\s+NET\s+AMOUNT\s+([\d,]+\.?\d*)(CR|DB)?/i);if(l){const d=p(l[1]);t.finalSettlementNetAmount={amount:l[2]==="DB"?-d:d,type:l[2]||"CR"}}}}}return t}function $(a){const o=U(a),t=v(a);return{reportType:"VSS-115",header:o,data:t,rawContent:a}}function w(a){return/REPORT\s+ID:\s+VSS-115/i.test(a)&&/SRE\s+SETTLEMENT\s+RECAP\s+REPORT/i.test(a)}function B(a){return a.split(/(?=REPORT\s+ID:)/i).map(t=>t.trim()).filter(t=>t.length>0&&/REPORT\s+ID:/i.test(t))}function C(a){return F(a)?"VSS-110":w(a)?"VSS-115":/REPORT\s+ID:\s*SMS6/i.test(a)?"SMS":"UNKNOWN"}function H(a,o){const t={smsReports:[],vssReports:[],totalSMSReports:0,totalVSSReports:0,totalTransactions:0,errors:[]},r=a.split(`
`).length;o?.({status:"parsing",currentLine:0,totalLines:r,smsReportsFound:0,vssReportsFound:0,transactionsParsed:0,message:"Starting to parse reports..."});try{const s=B(a);let i=[];const e=[];for(const l of s){const d=C(l);d==="SMS"?i.push(l):(d==="VSS-110"||d==="VSS-115")&&e.push(l)}if(i.length>0){const l=M(i,d=>{o?.({status:"parsing",currentLine:d.currentLine,totalLines:d.totalLines,smsReportsFound:d.reportsFound,vssReportsFound:e.length,transactionsParsed:d.transactionsParsed,message:`Parsing SMS reports: ${d.reportsFound} found, ${d.transactionsParsed} transactions`})});t.smsReports=l.reports,t.totalSMSReports=t.smsReports.length,t.totalTransactions=t.smsReports.reduce((d,m)=>d+m.transactions.length,0)}for(const l of e)try{const d=C(l);if(d==="VSS-110"){const m=D(l);t.vssReports.push(m),t.totalVSSReports++}else if(d==="VSS-115"){const m=$(l);t.vssReports.push(m),t.totalVSSReports++}o?.({status:"parsing",currentLine:r,totalLines:r,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Parsed ${t.totalSMSReports} SMS reports and ${t.totalVSSReports} VSS reports`})}catch(d){const m=d instanceof Error?d.message:"Unknown error";t.errors.push(`Error parsing VSS report: ${m}`)}o?.({status:"completed",currentLine:r,totalLines:r,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Parsing complete: ${t.totalSMSReports} SMS reports, ${t.totalVSSReports} VSS reports`})}catch(s){const i=s instanceof Error?s.message:"Unknown error";t.errors.push(`Fatal error during parsing: ${i}`),o?.({status:"error",currentLine:0,totalLines:r,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:i})}return t}function G(a,o){const t={smsReports:[],vssReports:[],totalSMSReports:0,totalVSSReports:0,totalTransactions:0,errors:[]};for(let n=0;n<a.length;n++){const r=a[n];o?.({status:"parsing",currentLine:n,totalLines:a.length,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Processing file ${n+1} of ${a.length}: ${r.name}`});try{const s=H(r.content,i=>{o?.({...i,message:`[${r.name}] ${i.message}`})});t.smsReports=t.smsReports.concat(s.smsReports),t.vssReports=t.vssReports.concat(s.vssReports),t.totalSMSReports+=s.totalSMSReports,t.totalVSSReports+=s.totalVSSReports,t.totalTransactions+=s.totalTransactions,t.errors=t.errors.concat(s.errors)}catch(s){const i=s instanceof Error?s.message:"Unknown error";t.errors.push(`Error parsing file ${r.name}: ${i}`)}}return o?.({status:"completed",currentLine:a.length,totalLines:a.length,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`All files processed: ${t.totalSMSReports} SMS reports, ${t.totalVSSReports} VSS reports from ${a.length} file(s)`}),t}self.onmessage=a=>{const{type:o,payload:t}=a.data;if(o==="parse")try{const n=G(t.files,r=>{self.postMessage({type:"progress",payload:r})});self.postMessage({type:"result",payload:n})}catch(n){self.postMessage({type:"error",payload:{message:n instanceof Error?n.message:"Unknown parsing error"}})}}})();
