(function(){"use strict";const A={reportId:/REPORT ID:\s*(SMS6\d+[A-Z]?)/i,pageNumber:/PAGE NUMBER\s*:\s*(\d+)/i,fundsTransfer:/FUNDS XFR:\s*(\d+)\s+(.+?)\s{2,}/i,processor:/PROCESSOR:\s*(\d+)\s+(.+?)\s{2,}/i,affiliate:/AFFILIATE:\s*(\d+)\s+(.+?)\s{2,}/i,sre:/SRE\s*:\s*(\d+)\s+(.+?)\s{2,}/i,onlineSettlementDate:/ONLINE SETTLMNT DATE:\s*(\d{2}\w{3}\d{2})/i,runDate:/(RUN DATE|REPORT DATE)\s*:\s*(\d{2}\w{3}\d{2})/i,runTime:/(RUN TIME|REPORT TIME)\s*:\s*(\d{2}:\d{2}:\d{2})/i,vssProcessingDate:/VSS PROCESSING DATE\s*:\s*(\d{2}\w{3}\d{2})/i,settlementCurrency:/AMOUNT\s*\(([A-Z]{3})\)/i,nationalNet:/NATIONAL NET/i,transactionLine1:/^\s*(\d+)\s+(\d{2}\w{3})\s+(\d{2}:\d{2}:\d{2})\s+([\dxX]+)\s+(\S+)\s+(\d+)\s+(\d+)\s+(\d{4})\s+(\d{6})\s+(\d+(?:\.\d{2})?)\s+(\d+(?:\.\d{2})?)\s+(\d+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)\s+([A-Z]{3})\s+([\d,]+(?:\.\d{2})?)\s*(?:(CR|DR))?\s*$/i,transactionLine1Extended:/^\s*(\d+)\s+(\d{2}\w{3})\s+(\d{2}:\d{2}:\d{2})\s+([\dxX]+)\s+(\S+)\s+(\d+)\s+(\d+)\s+(\d{4})\s+(\d{6})\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([A-Z]{3})\s+([\d,]+(?:\.\d{2})?)\s*(?:(CR|DR))?\s*$/i,transactionLine1SMS612:/^\s*(\d+)\s+(\d{2}\w{3})\s+(\d{2}:\d{2}:\d{2})\s+([\dxX]+)\s+(\S+)\s+(\d+)\s+(\d+)\s+(\d{4})\s+(\d{6})\s+(\d+)\s+(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([A-Z]{3})\s+([\d,]+(?:\.\d{2})?)\s*(?:(CR|DR))?\s*$/i,transactionLine2:/^\s*(\d{4}|\d{2}\w{3})?\s*(\d{2}:\d{2}:\d{2})?\s*CA ID:\s*(\S+)?\s+(\S+)?\s+(\d+)?\s+(\d{2})?\/(.+?)\/(\w{2})(?:\s+(\d{4}))?/i,transactionLine3CDSQ:/CD SQ:\s*(\d+)\s+ATC:\s*(\w+)(?:\s+CI:\s*(\d+))?(?:\s+M\/EC:\s*(\w+))?(?:\s+AP:\s*(\w+))?/i,transactionLine3ATC:/ATC:\s*(\w+)(?:\s+CI:\s*(\d+))?(?:\s+M\/EC:\s*(\w+))?/i,transactionLine4Usage:/USAGE:\s*(\w+)\s+TR ID:\s*([\w\/]+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?(?:\s+PTS:\s*([\w\s]+))?(?:\s+PMC:\s*(\w+))?(?:\s+SCHG:\s*([\d,\.]+))?/i,transactionLine4DgCd:/DG CD:\s*(\w+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?/i,transactionLine4TrId:/TR ID:\s*([\w\/]+)(?:\s+ACI:\s*(\w+))?(?:\s+VC:\s*(\w+))?/i,transactionLine5:/FEE JURIS:\s*(.+?)\s+ROUTING:\s*(.+?)\s+FEE LEVEL:\s*(.+?)\s+([\d,\.]+)(CR|DR)?/i,transactionLine5RoutingOnly:/ROUTING:\s*(.+?)(?:\s+FEE LEVEL:|\s*$)/i,feeJuris:/FEE JURIS:/i,fpi:/FPI:\s*(\w+)/i,affiliateSummary:/AFFILIATE ID:\s*(\d+)\s+(.+?)(?:,|\s{2,})/i,debitsLine:/DEBITS\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})DR/i,creditsLine:/CREDITS\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})CR/i,totalLine:/TOTAL\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})(CR|DR)/i,subtotalLine:/SUBTOTAL\s*:\s*(\d+)\s+([\d,]+\.\d{2})\s+([\d,]+\.\d{2})(CR|DR)/i,nonFinancialLine:/NON FINANCIAL\s*:\s*(\d+)/i,totalFeesLine:/TOTAL FEES\s*:\s*(\d+)/i,debitsLineExtended:/DEBITS\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,creditsLineExtended:/CREDITS\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,subtotalLineExtended:/SUBTOTAL\s*:\s*(\d+)\s+([\d,]+(?:\.\d{2})?)\s+([\d,]+(?:\.\d{2})?)(CR|DR)/i,totalFeesLineExtended:/TOTAL FEES\s*:\s*(\d+)\s+([\d,.]+)(CR|DR)/i},g={"00":"Purchase/Sale","01":"Cash Advance","09":"Purchase with Cashback",10:"Financial Cash Withdrawal",11:"Cash Transaction Reversal",20:"Balance Inquiry",22:"Purchase Refund",26:"Cash Advance Refund",30:"Funds Transfer",31:"Utility Payment",40:"Cardholder Account Transfer",50:"ATM Withdrawal",51:"PIN Unblock",90:"Administrative Message"},C={"00":"Not Specified / Not Applicable",10:"Savings Account",20:"Checking Account (Current Account)",30:"Credit Card Account",40:"Universal Account",50:"Investment Account",60:"Bonus Account"};function h(i){if(!/^\d{6}$/.test(i))return;const a=i.substring(0,2),t=i.substring(2,4),o=i.substring(4,6);return{transactionType:a,transactionTypeDescription:g[a]||`Unknown (${a})`,fromAccountType:t,fromAccountTypeDescription:C[t]||`Unknown (${t})`,toAccountType:o,toAccountTypeDescription:C[o]||`Unknown (${o})`}}function N(i){const a=i.split(`
`);let t={};for(let o=0;o<Math.min(20,a.length);o++){const e=a[o],r=e.match(A.reportId),s=e.match(A.pageNumber),n=e.match(A.fundsTransfer),u=e.match(A.processor),l=e.match(A.affiliate),T=e.match(A.sre),d=e.match(A.onlineSettlementDate),m=e.match(A.runDate),R=e.match(A.runTime),c=e.match(A.vssProcessingDate),p=e.match(A.settlementCurrency);r&&(t.reportId=r[1]),s&&(t.pageNumber=parseInt(s[1])),n&&(t.fundsTransferSRE=n[1],t.fundsTransferName=n[2].trim()),u&&(t.processor=u[1],t.processorName=u[2].trim()),l&&(t.affiliate=l[1],t.affiliateName=l[2].trim()),T&&(t.sre=T[1],t.sreName=T[2].trim()),d&&(t.onlineSettlementDate=d[1]),m&&(t.runDate=m[2]),R&&(t.runTime=R[2]),c&&(t.vssProcessingDate=c[1]),p&&(t.settlementCurrency=p[1]),A.nationalNet.test(e)&&(t.nationalNet=!0)}if(t.settlementCurrency||(t.settlementCurrency="USD"),t.sreName){const o=t.sreName.match(/^(\d{6,8})/);if(o){let e=o[1];t.bin=e}}if(!t.bin&&t.affiliate){const o=t.affiliate.substring(0,8);if(/^\d{8}$/.test(o)){let e=o;e.length===8&&e.endsWith("00")&&(e=e.substring(0,6)),t.bin=e}}return t.reportId?t:null}function b(i,a){const t=i.split(`
`),o=[];let e=0;for(;e<t.length;){const r=t[e].trim();let s=r.match(A.transactionLine1Extended),n=!!s,u=!1;if(s||(s=r.match(A.transactionLine1SMS612),u=!!s),s||(s=r.match(A.transactionLine1)),s){let l=s[4];const T=/[xX]/.test(l);let d=l;d.length===16?d=l:d.length===19&&d.endsWith("000")?d=l.substring(0,16):d.length>16&&d.endsWith("000")&&(d=d.substring(0,d.length-3));let m;if(n){const R=s[9],c=h(R);m={batchNumber:s[1],transmitDate:s[2],transmitTime:s[3],cardNumber:d,masked:T||void 0,retrievalRefNumber:s[5],traceNumber:s[6],acquirerId:s[7],transactionType:s[8],processingCode:R,processingCodeParsed:c,transactionSubtype:c?.transactionTypeDescription,entryMode:s[10],reasonCode:s[11],conditionCode:s[12],responseCode:s[13],cardholderBillingAmount:s[14],cardholderBillingCurrency:s[15],settlementAmount:s[16],settlementCurrency:a.settlementCurrency,settlementType:s[17]||"DR"}}else if(u){const R=s[9],c=h(R);m={batchNumber:s[1],transmitDate:s[2],transmitTime:s[3],cardNumber:d,masked:T||void 0,retrievalRefNumber:s[5],traceNumber:s[6],acquirerId:s[7],transactionType:s[8],processingCode:R,processingCodeParsed:c,transactionSubtype:c?.transactionTypeDescription,reasonCode:s[10],responseCode:s[11],cardholderBillingAmount:s[12],cardholderBillingCurrency:s[13],settlementAmount:s[14],settlementCurrency:a.settlementCurrency,settlementType:s[15]||"DR"}}else{const R=s[9],c=h(R);m={batchNumber:s[1],transmitDate:s[2],transmitTime:s[3],cardNumber:d,masked:T||void 0,retrievalRefNumber:s[5],traceNumber:s[6],acquirerId:s[7],transactionType:s[8],processingCode:R,processingCodeParsed:c,transactionSubtype:c?.transactionTypeDescription,entryMode:s[10],reasonCode:s[11],responseCode:s[12],cardholderBillingAmount:s[13],cardholderBillingCurrency:s[14],settlementAmount:s[15],settlementCurrency:a.settlementCurrency,settlementType:s[16]||"DR"}}if(e++,e<t.length&&t[e].includes("CA ID:")){const R=t[e],c=R.match(A.transactionLine2);c&&(c[3]&&(m.cardAcceptorTerminalId=c[3]),c[4]&&(m.cardAcceptorId=c[4]),c[7]&&(m.merchantName=c[7].trim()),c[8]&&(m.merchantCountryCode=c[8]));const p=R.match(A.fpi);p&&(m.feeProgramIndicator=p[1]),e++}if(e<t.length){const R=t[e];(R.match(A.transactionLine3CDSQ)||R.match(A.transactionLine3ATC)||R.includes("M/EC:"))&&e++}if(e<t.length){const R=t[e],c=R.match(A.transactionLine4Usage);if(c)m.usage=c[1],m.transactionIdentifier=c[2],c[3]&&(m.authCharIndicator=c[3]),c[4]&&(m.validationCode=c[4]),e++;else{const p=R.match(A.transactionLine4DgCd);if(p)m.downgradeCode=p[1],p[2]&&(m.authCharIndicator=p[2]),p[3]&&(m.validationCode=p[3]),e++;else{const f=R.match(A.transactionLine4TrId);f&&(m.transactionIdentifier=f[1],f[2]&&(m.authCharIndicator=f[2]),f[3]&&(m.validationCode=f[3]),e++)}}}if(e<t.length){const R=t[e];if(A.feeJuris.test(R)){const c=R.match(A.transactionLine5);c&&(m.feeJurisdiction=c[1].trim(),m.routing=c[2].trim(),m.feeLevel=c[3].trim(),c[4]&&(m.feeAmount=c[4],c[5]&&(m.feeType=c[5]))),e++}else if(R.includes("ROUTING:")){const c=R.match(A.transactionLine5RoutingOnly);c&&(m.routing=c[1].trim()),e++}}o.push(m)}else e++}return o}function M(i){const a=i.split(`
`);let t={};for(const o of a){const e=o.match(A.affiliateSummary),r=o.match(A.debitsLine),s=o.match(A.creditsLine),n=o.match(A.totalLine),u=o.match(A.subtotalLine),l=o.match(A.nonFinancialLine),T=o.match(A.totalFeesLine),d=o.match(A.debitsLineExtended),m=o.match(A.creditsLineExtended),R=o.match(A.subtotalLineExtended),c=o.match(A.totalFeesLineExtended);if(e&&(t.affiliateId=e[1],t.affiliateName=e[2].trim()),d?(t.debitsCount=parseInt(d[1]),t.debitsAmount=d[3],t.debits={count:parseInt(d[1]),billingAmount:d[2],settlementAmount:d[3],settlementType:d[4]}):r&&(t.debitsCount=parseInt(r[1]),t.debitsAmount=r[3]),m?(t.creditsCount=parseInt(m[1]),t.creditsAmount=m[3],t.credits={count:parseInt(m[1]),billingAmount:m[2],settlementAmount:m[3],settlementType:m[4]}):s&&(t.creditsCount=parseInt(s[1]),t.creditsAmount=s[3]),R)t.totalCount=parseInt(R[1]),t.totalAmount=R[3],t.totalType=R[4],t.subtotal={count:parseInt(R[1]),billingAmount:R[2],settlementAmount:R[3],settlementType:R[4]};else if(n||u){const p=n||u;p&&(t.totalCount=parseInt(p[1]),t.totalAmount=p[3],t.totalType=p[4])}l&&(t.nonFinancialCount=parseInt(l[1])),c?(t.totalFeesCount=parseInt(c[1]),t.totalFeesAmount=c[2],t.totalFees={count:parseInt(c[1]),amount:c[2],type:c[3]}):T&&(t.totalFeesCount=parseInt(T[1]))}return t.affiliateId?t:null}function L(i,a){const t=[],o={status:"parsing",currentLine:0,totalLines:i.split(`
`).length,reportsFound:0,transactionsParsed:0};try{const e=i.split(/REPORT ID:/i);for(let s=1;s<e.length;s++){const n=e[s],u="REPORT ID:"+n;if(/^\s*SMS6/i.test(n)){const l=N(u);if(l){const T=b(u,l),d=M(u),m={header:l,transactions:T,summary:d||void 0,rawContent:u};t.push(m),o.reportsFound++,o.transactionsParsed+=T.length,a?.(o)}}}o.status="completed",a?.(o);const r={totalReports:t.length,totalTransactions:o.transactionsParsed,totalDebits:t.reduce((s,n)=>s+n.transactions.filter(u=>u.settlementType==="DR").length,0),totalCredits:t.reduce((s,n)=>s+n.transactions.filter(u=>u.settlementType==="CR").length,0)};return{reports:t,progress:o,summary:r}}catch(e){throw o.status="error",o.errorMessage=e instanceof Error?e.message:"Unknown error",a?.(o),e}}function S(i){const a=i.replace(/,/g,"").trim();return parseFloat(a)||0}function O(i){const a=/^\s*TOTAL\s+(?:ACQUIRER|ISSUER|OTHER|INTERCHANGE\s+VALUE|REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=/^\s*TOTAL\s+(?:ACQUIRER|ISSUER|OTHER|INTERCHANGE\s+VALUE|REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,o=/^\s*NET\s+SETTLEMENT\s+AMOUNT\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i;let e=i.match(a);if(e){const r=parseInt(e[1].replace(/,/g,"")),s=S(e[2]),n=S(e[3]),u=S(e[4]);return{count:r,creditAmount:s,debitAmount:n,totalAmount:e[5]==="DB"?-u:u}}if(e=i.match(t),e){const r=S(e[1]),s=S(e[2]),n=S(e[3]);return{creditAmount:r,debitAmount:s,totalAmount:e[4]==="DB"?-n:n}}if(e=i.match(o),e){const r=S(e[1]),s=S(e[2]),n=S(e[3]);return{creditAmount:r,debitAmount:s,totalAmount:e[4]==="DB"?-n:n}}return null}function D(i){const a=i.split(`
`),t={reportId:"",pageNumber:1,reportingFor:"",reportingForName:"",rollupTo:"",rollupToName:"",fundsTransferEntity:"",fundsTransferEntityName:"",settlementService:"",reportTitle:"",settlementCurrency:"",processingDate:"",reportDate:""};return a.forEach((o,e)=>{const r=o.match(/REPORT\s+ID:\s+(VSS-\d+)\s+(.+?)\s+PAGE:\s+(\d+)/i);if(r){t.reportId=r[1],t.settlementService=r[2].trim(),t.pageNumber=parseInt(r[3]),t.lineNumber=e+1;return}let s=o.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s{2,}([A-Z\s]+SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i);if(s||(s=o.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*?)\s+([A-Z]+\s+(?:[A-Z]+\s+)*SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i)),s){t.reportingFor=s[1],t.reportingForName=s[2].trim().replace(/\s+/g," "),t.settlementService=s[3].trim(),t.processingDate=s[4].trim();return}let n=o.match(/ROLLUP\s+TO:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s+(SETTLEMENT\s+SUMMARY\s+REPORT|SRE\s+SETTLEMENT\s+RECAP\s+REPORT)\s+REPORT\s+DATE:\s+(\S+)\s*$/i);if(n){t.rollupTo=n[1],t.rollupToName=n[2].trim().replace(/\s+/g," "),t.reportTitle=n[3].trim(),t.reportDate=n[4].trim();return}const u=o.match(/FUNDS\s+(?:XFER|TRANSFER)\s+ENTITY:\s+(\d+)\s+(.+?)\s*$/i);if(u){t.fundsTransferEntity=u[1],t.fundsTransferEntityName=u[2].trim();return}const l=o.match(/SETTLEMENT\s+CURRENCY:\s+([A-Z]{3})/i);if(l){t.settlementCurrency=l[1];return}const T=o.match(/CLEARING\s+CURRENCY:\s+([A-Z]{3})/i);if(T){t.clearingCurrency=T[1];return}const d=o.match(/FOR\s+(.+?)\s+THROUGH\s+(.+?)(?:\s+LAST\s+CHANGE:\s+(.+?))?$/i);if(d){t.forDate=d[1].trim(),t.throughDate=d[2].trim(),d[3]&&(t.lastChange=d[3].trim());return}}),t}function y(i){const a=i.split(`
`),t={interchangeValue:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},reimbursementFees:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},visaCharges:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},total:{creditAmount:0,debitAmount:0,totalAmount:0}},total:{totalAcquirer:{creditAmount:0,debitAmount:0,totalAmount:0},totalIssuer:{creditAmount:0,debitAmount:0,totalAmount:0},totalOther:{creditAmount:0,debitAmount:0,totalAmount:0},netSettlementAmount:{creditAmount:0,debitAmount:0,totalAmount:0}}},o=i.match(/FUNDS\s+TRANSFER\s+AMOUNT:\s+([\d,]+\.?\d*)(CR|DB)?/i);if(o){const r=S(o[1]);t.fundsTransferAmount={amount:o[2]==="DB"?-r:r,type:o[2]||"CR"}}let e="";for(let r=0;r<a.length;r++){const s=a[r];if(/^\s*INTERCHANGE\s+VALUE\s*$/i.test(s)){e="INTERCHANGE_VALUE";continue}if(/^\s*REIMBURSEMENT\s+FEES\s*$/i.test(s)){e="REIMBURSEMENT_FEES";continue}if(/^\s*VISA\s+CHARGES\s*$/i.test(s)){e="VISA_CHARGES";continue}if(/^\s*TOTAL\s*$/i.test(s)&&!s.match(/TOTAL\s+(ACQUIRER|ISSUER|OTHER)/i)){e="TOTAL";continue}const n=O(s);n&&(e==="INTERCHANGE_VALUE"?/TOTAL\s+ACQUIRER/i.test(s)?t.interchangeValue.totalAcquirer=n:/TOTAL\s+ISSUER/i.test(s)?t.interchangeValue.totalIssuer=n:/TOTAL\s+OTHER/i.test(s)?t.interchangeValue.totalOther=n:/TOTAL\s+INTERCHANGE\s+VALUE/i.test(s)&&(t.interchangeValue.total=n):e==="REIMBURSEMENT_FEES"?/TOTAL\s+ACQUIRER/i.test(s)?t.reimbursementFees.totalAcquirer=n:/TOTAL\s+ISSUER/i.test(s)?t.reimbursementFees.totalIssuer=n:/TOTAL\s+OTHER/i.test(s)?t.reimbursementFees.totalOther=n:/TOTAL\s+REIMBURSEMENT\s+FEES/i.test(s)&&(t.reimbursementFees.total=n):e==="VISA_CHARGES"?/TOTAL\s+ACQUIRER/i.test(s)?t.visaCharges.totalAcquirer=n:/TOTAL\s+ISSUER/i.test(s)?t.visaCharges.totalIssuer=n:/TOTAL\s+OTHER/i.test(s)?t.visaCharges.totalOther=n:/TOTAL\s+VISA\s+CHARGES/i.test(s)&&(t.visaCharges.total=n):e==="TOTAL"&&(/TOTAL\s+ACQUIRER/i.test(s)?t.total.totalAcquirer=n:/TOTAL\s+ISSUER/i.test(s)?t.total.totalIssuer=n:/TOTAL\s+OTHER/i.test(s)?t.total.totalOther=n:/NET\s+SETTLEMENT\s+AMOUNT/i.test(s)&&(t.total.netSettlementAmount=n)))}return t}function F(i){const a=D(i),t=y(i);return{reportType:"VSS-110",header:a,data:t,rawContent:i}}function U(i){return/REPORT\s+ID:\s+VSS-110/i.test(i)&&/SETTLEMENT\s+SUMMARY\s+REPORT/i.test(i)}function E(i){const a=i.replace(/,/g,"").trim();return parseFloat(a)||0}function P(i){const a=i.split(`
`),t={reportId:"",pageNumber:1,reportingFor:"",reportingForName:"",rollupTo:"",rollupToName:"",fundsTransferEntity:"",fundsTransferEntityName:"",settlementService:"",reportTitle:"",settlementCurrency:"",processingDate:"",reportDate:""};return a.forEach((o,e)=>{const r=o.match(/REPORT\s+ID:\s+(VSS-\d+)\s+(.+?)\s+PAGE:\s+(\d+)/i);if(r){t.reportId=r[1],t.settlementService=r[2].trim(),t.pageNumber=parseInt(r[3]),t.lineNumber=e+1;return}let s=o.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s{2,}([A-Z\s]+SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i);if(s||(s=o.match(/REPORTING\s+FOR:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*?)\s+([A-Z]+\s+(?:[A-Z]+\s+)*SERVICE)\s+PROC\s+DATE:\s+(\S+)\s*$/i)),s){t.reportingFor=s[1],t.reportingForName=s[2].trim().replace(/\s+/g," "),t.settlementService=s[3].trim(),t.processingDate=s[4].trim();return}let n=o.match(/ROLLUP\s+TO:\s+(\d+)\s+([A-Z0-9]+(?:\s+[A-Z0-9]+)*)\s+(SETTLEMENT\s+SUMMARY\s+REPORT|SRE\s+SETTLEMENT\s+RECAP\s+REPORT)\s+REPORT\s+DATE:\s+(\S+)\s*$/i);if(n){t.rollupTo=n[1],t.rollupToName=n[2].trim().replace(/\s+/g," "),t.reportTitle=n[3].trim(),t.reportDate=n[4].trim();return}const u=o.match(/FUNDS\s+(?:XFER|TRANSFER)\s+ENTITY:\s+(\d+)\s+(.+?)\s*$/i);if(u){t.fundsTransferEntity=u[1],t.fundsTransferEntityName=u[2].trim();return}const l=o.match(/SETTLEMENT\s+CURRENCY:\s+([A-Z]{3})/i);if(l){t.settlementCurrency=l[1];return}const T=o.match(/CLEARING\s+CURRENCY:\s+([A-Z]{3})/i);if(T){t.clearingCurrency=T[1];return}const d=o.match(/FOR\s+(.+?)\s+THROUGH\s+(.+?)(?:\s+LAST\s+CHANGE:\s+(.+?))?$/i);if(d){t.forDate=d[1].trim(),t.throughDate=d[2].trim(),d[3]&&(t.lastChange=d[3].trim());return}}),t}function V(i){if(/^\s*(TOTAL|REIMBURSEMENT|VISA|FINAL)/i.test(i))return null;const a=/^\s*([A-Z][A-Z\s\-]+?)\s{2,}(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)\s+(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)\s+(?:(\d+(?:,\d{3})*)\s+)?([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=i.match(a);if(!t)return null;const o=t[1].trim(),e=t[2]?parseInt(t[2].replace(/,/g,"")):0,r=E(t[3]),s=t[4]?parseInt(t[4].replace(/,/g,"")):0,n=E(t[5]),u=t[6]?parseInt(t[6].replace(/,/g,"")):0,l=E(t[7]),T=t[8];return{name:o,creditsCount:e,creditsAmount:r,debitsCount:s,debitsAmount:n,totalCount:u,totalAmount:T==="DB"?-l:l}}function v(i){const a=/^\s*(?:TOTAL\s+INTERCHANGE|TOTAL\s+ACQUIRER|TOTAL\s+ISSUER|TOTAL\s+OTHER|TOTAL)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)\s+(\d+(?:,\d{3})*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,t=/^\s*(?:REIMBURSEMENT\s+FEES|VISA\s+CHARGES)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i,o=/^\s*FINAL\s+SETTLEMENT\s+NET\s+AMOUNT\s+([\d,]+\.?\d*)(CR|DB)?\s*$/i;let e=i.match(a);return e?{creditsCount:parseInt(e[1].replace(/,/g,"")),creditsAmount:E(e[2]),debitsCount:parseInt(e[3].replace(/,/g,"")),debitsAmount:E(e[4]),totalCount:parseInt(e[5].replace(/,/g,"")),totalAmount:e[7]==="DB"?-E(e[6]):E(e[6])}:(e=i.match(t),e?{creditsAmount:E(e[1]),debitsAmount:E(e[2]),totalAmount:e[4]==="DB"?-E(e[3]):E(e[3])}:(e=i.match(o),e?{creditsAmount:0,debitsAmount:0,totalAmount:e[2]==="DB"?-E(e[1]):E(e[1])}:null))}function $(i){const a=i.split(`
`),t={acquirerTransactions:{transactionTypes:[],totalInterchange:{creditsAmount:0,debitsAmount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalAcquirer:{creditsAmount:0,debitsAmount:0,totalAmount:0}},issuerTransactions:{transactionTypes:[],totalInterchange:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalIssuer:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0}},otherTransactions:{transactionTypes:[],totalInterchange:{creditsAmount:0,debitsAmount:0,totalAmount:0},reimbursementFees:{creditsAmount:0,debitsAmount:0,totalAmount:0},visaCharges:{creditsAmount:0,debitsAmount:0,totalAmount:0},totalOther:{creditsAmount:0,debitsAmount:0,totalAmount:0}},total:{creditsCount:0,creditsAmount:0,debitsCount:0,debitsAmount:0,totalCount:0,totalAmount:0},finalSettlementNetAmount:{amount:0,type:"CR"}};let o="";for(let e=0;e<a.length;e++){const r=a[e];if(/^\s*ACQUIRER\s+TRANSACTIONS\s*$/i.test(r)){o="ACQUIRER";continue}if(/^\s*ISSUER\s+TRANSACTIONS\s*$/i.test(r)){o="ISSUER";continue}if(/^\s*OTHER\s+TRANSACTIONS\s*$/i.test(r)){o="OTHER";continue}const s=V(r);if(s){o==="ACQUIRER"?t.acquirerTransactions.transactionTypes.push(s):o==="ISSUER"?t.issuerTransactions.transactionTypes.push(s):o==="OTHER"&&t.otherTransactions.transactionTypes.push(s);continue}const n=v(r);if(n){if(/^\s*TOTAL\s+\d/i.test(r)&&!/TOTAL\s+(INTERCHANGE|ACQUIRER|ISSUER|OTHER)/i.test(r)&&n.creditsCount!==void 0&&n.totalCount!==void 0){t.total={creditsCount:n.creditsCount,creditsAmount:n.creditsAmount,debitsCount:n.debitsCount||0,debitsAmount:n.debitsAmount,totalCount:n.totalCount,totalAmount:n.totalAmount};continue}if(o==="ACQUIRER"?/TOTAL\s+INTERCHANGE/i.test(r)?t.acquirerTransactions.totalInterchange={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(r)?t.acquirerTransactions.reimbursementFees={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/VISA\s+CHARGES/i.test(r)?t.acquirerTransactions.visaCharges={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/TOTAL\s+ACQUIRER/i.test(r)&&(t.acquirerTransactions.totalAcquirer={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}):o==="ISSUER"?/TOTAL\s+INTERCHANGE/i.test(r)?t.issuerTransactions.totalInterchange={creditsCount:n.creditsCount||0,creditsAmount:n.creditsAmount,debitsCount:n.debitsCount||0,debitsAmount:n.debitsAmount,totalCount:n.totalCount||0,totalAmount:n.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(r)?t.issuerTransactions.reimbursementFees={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/VISA\s+CHARGES/i.test(r)?t.issuerTransactions.visaCharges={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/TOTAL\s+ISSUER/i.test(r)&&(t.issuerTransactions.totalIssuer={creditsCount:n.creditsCount||0,creditsAmount:n.creditsAmount,debitsCount:n.debitsCount||0,debitsAmount:n.debitsAmount,totalCount:n.totalCount||0,totalAmount:n.totalAmount}):o==="OTHER"&&(/TOTAL\s+INTERCHANGE/i.test(r)?t.otherTransactions.totalInterchange={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/REIMBURSEMENT\s+FEES/i.test(r)?t.otherTransactions.reimbursementFees={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/VISA\s+CHARGES/i.test(r)?t.otherTransactions.visaCharges={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount}:/TOTAL\s+OTHER/i.test(r)&&(t.otherTransactions.totalOther={creditsAmount:n.creditsAmount,debitsAmount:n.debitsAmount,totalAmount:n.totalAmount})),/FINAL\s+SETTLEMENT\s+NET\s+AMOUNT/i.test(r)){const u=r.match(/FINAL\s+SETTLEMENT\s+NET\s+AMOUNT\s+([\d,]+\.?\d*)(CR|DB)?/i);if(u){const l=E(u[1]);t.finalSettlementNetAmount={amount:u[2]==="DB"?-l:l,type:u[2]||"CR"}}}}}return t}function w(i){const a=P(i),t=$(i);return{reportType:"VSS-115",header:a,data:t,rawContent:i}}function B(i){return/REPORT\s+ID:\s+VSS-115/i.test(i)&&/SRE\s+SETTLEMENT\s+RECAP\s+REPORT/i.test(i)}function H(i){return i.split(/(?=REPORT\s+ID:)/i).map(t=>t.trim()).filter(t=>t.length>0&&/REPORT\s+ID:/i.test(t))}function I(i){return U(i)?"VSS-110":B(i)?"VSS-115":/REPORT\s+ID:\s*SMS6/i.test(i)?"SMS":"UNKNOWN"}function G(i,a){const t={smsReports:[],vssReports:[],totalSMSReports:0,totalVSSReports:0,totalTransactions:0,errors:[]},e=i.split(`
`).length;a?.({status:"parsing",currentLine:0,totalLines:e,smsReportsFound:0,vssReportsFound:0,transactionsParsed:0,message:"Starting to parse reports..."});try{const r=H(i);let s=[];const n=[];for(const u of r){const l=I(u);l==="SMS"?s.push(u):(l==="VSS-110"||l==="VSS-115")&&n.push(u)}if(s.length>0){const u=s.join(`

`),l=L(u,T=>{a?.({status:"parsing",currentLine:T.currentLine,totalLines:T.totalLines,smsReportsFound:T.reportsFound,vssReportsFound:n.length,transactionsParsed:T.transactionsParsed,message:`Parsing SMS reports: ${T.reportsFound} found, ${T.transactionsParsed} transactions`})});t.smsReports=l.reports,t.totalSMSReports=t.smsReports.length,t.totalTransactions=t.smsReports.reduce((T,d)=>T+d.transactions.length,0)}for(const u of n)try{const l=I(u);if(l==="VSS-110"){const T=F(u);t.vssReports.push(T),t.totalVSSReports++}else if(l==="VSS-115"){const T=w(u);t.vssReports.push(T),t.totalVSSReports++}a?.({status:"parsing",currentLine:e,totalLines:e,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Parsed ${t.totalSMSReports} SMS reports and ${t.totalVSSReports} VSS reports`})}catch(l){const T=l instanceof Error?l.message:"Unknown error";t.errors.push(`Error parsing VSS report: ${T}`)}a?.({status:"completed",currentLine:e,totalLines:e,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Parsing complete: ${t.totalSMSReports} SMS reports, ${t.totalVSSReports} VSS reports`})}catch(r){const s=r instanceof Error?r.message:"Unknown error";t.errors.push(`Fatal error during parsing: ${s}`),a?.({status:"error",currentLine:0,totalLines:e,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:s})}return t}function Z(i,a){const t={smsReports:[],vssReports:[],totalSMSReports:0,totalVSSReports:0,totalTransactions:0,errors:[]};for(let o=0;o<i.length;o++){const e=i[o];a?.({status:"parsing",currentLine:o,totalLines:i.length,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`Processing file ${o+1} of ${i.length}: ${e.name}`});try{const r=G(e.content,s=>{a?.({...s,message:`[${e.name}] ${s.message}`})});t.smsReports.push(...r.smsReports),t.vssReports.push(...r.vssReports),t.totalSMSReports+=r.totalSMSReports,t.totalVSSReports+=r.totalVSSReports,t.totalTransactions+=r.totalTransactions,t.errors.push(...r.errors)}catch(r){const s=r instanceof Error?r.message:"Unknown error";t.errors.push(`Error parsing file ${e.name}: ${s}`)}}return a?.({status:"completed",currentLine:i.length,totalLines:i.length,smsReportsFound:t.totalSMSReports,vssReportsFound:t.totalVSSReports,transactionsParsed:t.totalTransactions,message:`All files processed: ${t.totalSMSReports} SMS reports, ${t.totalVSSReports} VSS reports from ${i.length} file(s)`}),t}self.onmessage=i=>{const{type:a,payload:t}=i.data;if(a==="parse")try{const o=Z(t.files,e=>{self.postMessage({type:"progress",payload:e})});self.postMessage({type:"result",payload:o})}catch(o){self.postMessage({type:"error",payload:{message:o instanceof Error?o.message:"Unknown parsing error"}})}}})();
